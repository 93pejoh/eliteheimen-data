<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Eliteheimen Fantasy</title>
<meta name="description" content="Eliteheimen – interaktiv spilleroversikt for Fantasy Eliteserien." />
<meta name="data-last-updated" content="2025-10-15T13:02:00+02:00">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="icon" href="logo.png">

<style>
  :root { --radius:14px; --surface:#fff; --text:#0f172a; --muted:#667085; --border:#e5e7eb; --name-col-width:240px; }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:14px;color:var(--text);background:#fafafa}

  /* Tall: tabulære sifre for pen kolonnejustering */
  table, th, td {
    font-variant-numeric: tabular-nums lining-nums;
    font-feature-settings: "tnum" 1, "lnum" 1;
  }

  /* Hero */
  .hero{position:relative;overflow:hidden;border-radius:12px;padding:10px;margin-bottom:6px;color:#fff;
    background:radial-gradient(80% 120% at 10% -10%,rgba(14,165,233,.25),transparent 40%),
               radial-gradient(80% 120% at 110% 10%,rgba(34,197,94,.25),transparent 40%),
               linear-gradient(180deg,#0b1220,#111827);
    border:1px solid rgba(255,255,255,.06)}
  .hero-inner{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .brand{display:flex;gap:12px;align-items:center;background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(6px);border-radius:999px;padding:8px 12px}
  .brand img{width:36px;height:36px;border-radius:8px;object-fit:cover;background:#fff}
  .brand h1{margin:0;font-size:1.2rem;font-weight:800;letter-spacing:.2px}
  /* Tittel + småknapper på samme rad */
  .brand-title-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .brand-links{display:inline-flex;gap:6px;flex-wrap:wrap}

  @media (max-width:780px){
    .brand h1{ font-size:1.1rem; }
  }

  /* Toolbar (høyre side) */
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .toggle{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid #3b4152;
    background:rgba(255,255,255,.06);color:#e5e7eb;user-select:none}

  /* Nedlastningsknapp */
  .download-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: #f8fafc;
    border: 1px solid #d1d5db;
    border-radius: 999px;
    color: #0f172a;
    padding: 6px 12px;
    font-weight: 600;
    text-decoration: none;
    transition: background 0.2s, border-color 0.2s, color 0.2s;
  }
  .download-btn:hover { background:#e0f2fe; border-color:#93c5fd; color:#0c4a6e; }
  html.dark .download-btn {
    background: rgba(255,255,255,.12);
    border: 1px solid rgba(255,255,255,.3);
    color: #f8fafc;
  }
  html.dark .download-btn:hover {
    background: rgba(255,255,255,.25);
    border-color: rgba(255,255,255,.6);
    color: #fff;
  }

  /* Små hero-lenker (Om / Patreon) */
  .nav-link{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.2);
    color:#e5e7eb; font-weight:600; text-decoration:none;
    transition:background .2s, border-color .2s, color .2s;
    white-space:nowrap;
  }
  .nav-link:hover{
    background:rgba(255,255,255,.12);
    border-color:rgba(255,255,255,.45);
    color:#fff;
  }

  /* Filterbar (kompakt) */
  .filterbar{
    position:sticky; top:0; z-index:5;
    background:#fff; border:1px solid #e5e7eb; border-radius:10px;
    box-shadow:0 6px 20px rgba(2,8,23,.06);
    padding:6px 8px; margin:6px 0;
  }
  .filterbar-row{
    display:grid; align-items:center;
    grid-auto-flow:column; grid-template-columns:auto 1fr auto auto auto auto auto auto;
    gap:8px;
  }
  .filterbar .label{ color:#64748b; font-size:.85rem; white-space:nowrap; }
  .gap{ width:6px; }
  .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .chip{border:none;border-radius:999px;padding:2px 8px;background:#f2f4f7;cursor:pointer;user-select:none}
  .chip[aria-pressed="true"]{background:#e5effe;outline:2px solid #93c5fd}
  .pill.kpi-mini{background:#f8fafc;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;white-space:nowrap}
  .filterbar input[type="search"]{
    height:32px;border:1px solid #d1d5db;border-radius:10px;padding:0 10px;width:100%;
  }
  /* Klubb-dropdown */
  .filterbar select{
    height:32px;border:1px solid #d1d5db;border-radius:10px;padding:0 10px;background:#fff;
  }

  /* Pris – kompakt */
  .price-compact{display:inline-flex;align-items:center;gap:6px}
  .price-compact input[type="range"]{width:150px;height:3px}
  .muted{color:#666;font-size:.82rem}

  /* Tabell */
  .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;border:1px solid #e5e5e5;border-radius:10px;background:#fff;position:relative;margin-top:6px}
  table{border-collapse:collapse;width:100%;font-size:.92rem;line-height:1.25}
  thead th{position:sticky;top:0;background:#fafafa;border-bottom:1px solid #e5e5e5;padding:6px;white-space:nowrap;text-align:center;font-weight:700;letter-spacing:.3px;text-transform:uppercase;color:#0f172a;z-index:2}
  thead th button{background:transparent;border:none;font:inherit;cursor:pointer;color:inherit}
  thead th button:hover{text-decoration:underline}
  .sort-ind{opacity:1;font-size:.9em;margin-left:6px;color:#475569}
  tbody td{border-top:1px solid #f0f0f0;padding:4px 6px;white-space:nowrap;text-align:center}

  /* Zebra/hover – ikke overstyr celler som allerede har bakgrunn */
  tbody tr:nth-child(even) td:not([style*="background"]) { background:#fcfcfc; }
  tbody tr:hover td:not([style*="background"])            { background:#f3f7ff; }

  /* Sticky første kolonne (NAVN flyttes først i JS) */
  tbody td:first-child, thead th:first-child{position:sticky;left:0;z-index:3;background:#fff;box-shadow:1px 0 0 #eee}
  .pos-badge{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600;color:#111827}

  .legend{font-size:.85rem;color:#666;margin-top:4px}
  .footer-wrap{margin-top:12px;padding-top:8px;border-top:1px solid #e5e7eb;color:#64748b;display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .footer-wrap a{color:#64748b;text-decoration:none}
  .footer-wrap a:hover{color:#0ea5e9}

  /* Dark mode */
  html.dark body{background:#0b1220;color:#e5e7eb}
  html.dark .filterbar{background:#0f172a;border-color:#1f2a44;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  html.dark .filterbar input[type="search"]{background:#0b1325;color:#e5e7eb;border-color:#1f2a44}
  html.dark .filterbar select{background:#0b1325;color:#e5e7eb;border-color:#1f2a44}
  html.dark .chip{background:#111827;color:#e5e7eb}
  html.dark .chip[aria-pressed="true"]{background:#1f2937;outline-color:#334155}
  html.dark .table-wrap{border-color:#1f2a44;background:#0f172a}
  html.dark thead th{background:#0b1325 !important;color:#f1f5f9 !important;border-bottom-color:#223356 !important;box-shadow:0 2px 0 #0b1325,0 1px 0 #223356;z-index:3}
  html.dark thead th:first-child{background:#0b1325 !important;box-shadow:1px 0 0 #1f2a44,0 2px 0 #0b1325,0 1px 0 #223356}
  html.dark tbody td{border-top-color:#1a2743;background:transparent}
  /* Dark zebra/hover – ikke overstyr celler med egen bakgrunn */
  html.dark tbody tr:nth-child(even) td:not([style*="background"]) { background:#0e172a; }
  html.dark tbody tr:hover td:not([style*="background"])            { background:#122038; }
  html.dark tbody td:first-child{background:#0f172a;box-shadow:1px 0 0 #1f2a44}
  html.dark .legend, html.dark .footer-wrap{color:#a3adc2}

  /* Liten visuell hint om horisontal scroll */
  .table-wrap::after{
    content:"";position:absolute;right:0;top:0;bottom:0;width:18px;pointer-events:none;
    background:linear-gradient(to right, rgba(255,255,255,0), rgba(255,255,255,.95));
  }
  html.dark .table-wrap::after{
    background:linear-gradient(to right, rgba(15,23,42,0), rgba(15,23,42,.95));
  }

  /* Ekstra mobiljustering */
  @media (max-width: 780px){
    body{ margin:10px; }
    .filterbar-row{
      grid-template-columns:1fr 1fr;
      grid-auto-flow:row;
      gap:8px;
    }
    .pill.kpi-mini{ grid-column:1 / 2; }
    #q{ grid-column:2 / 3; }
    #pos-all, #pos-chips, #clubLabel, #clubSelect, .price-compact, #totalChipsWrap, #hideExcludedWrap{ grid-column:1 / -1; }
    .price-compact input[type="range"]{ width:100%; height:3px; }
    table{ font-size:.9rem; }
    thead th{ padding:6px; }
    tbody td{ padding:4px 6px; }
  }

  /* Fjern eventuell gammel KPI-seksjon hvis den skulle dukke opp */
  .cards, section.cards, .cards .card { display:none !important;height:0 !important;margin:0 !important;padding:0 !important;border:0 !important; }

  html.dark .pill.kpi-mini { color: #000 !important; background: #fff !important; }

  /* Sist oppdatert */
  #last-updated { font-size: 0.9rem; opacity: 0.85; color: #e7e7e7; margin-left: auto; display: flex; align-items: center; gap: 0.4rem; }
  #last-updated::before { content: "⏱️"; font-size: 1rem; opacity: 0.9; }

  /* Favorittstjerne i navnecella */
  .fav-btn{ display:inline-flex; align-items:center; justify-content:center; width:26px; height:26px; margin-right:0; border-radius:999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; vertical-align:middle; flex:0 0 26px; }
  .fav-btn .star::before{ content:"☆"; font-size:16px; line-height:1; }
  .fav-btn[aria-pressed="true"]{ background:#fef3c7; border-color:#f59e0b; }
  .fav-btn[aria-pressed="true"] .star::before{ content:"★"; }
  html.dark .fav-btn{ background:#0b1325; border-color:#1f2a44; color:#e5e7eb; }
  html.dark .fav-btn[aria-pressed="true"]{ background:#3a2a00; border-color:#f59e0b; color:#fcd34d; }

  /* Navne-blokk: fast bredde, sentrert i cella; grid = stjerne + navn */
  table thead th:first-child, table tbody td:first-child{ text-align:center; padding-left:6px; }
  .name-cell{ display:grid; grid-template-columns:26px 1fr; align-items:center; column-gap:6px; width:var(--name-col-width); max-width:calc(100% - 8px); margin:0 auto; }

  /* Filterknapp: vis kun favoritter (stjerne uten tekst) */
  .fav-filter{ display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:999px; border:1px solid #d1d5db; background:#fff; cursor:pointer; user-select:none; }
  .fav-filter::before{ content:"☆"; font-size:18px; line-height:1; }
  .fav-filter[aria-pressed="true"]{ background:#fef3c7; border-color:#f59e0b; }
  .fav-filter[aria-pressed="true"]::before{ content:"★"; }
  html.dark .fav-filter{ background:#0b1325; border-color:#1f2a44; color:#e5e7eb; }
  html.dark .fav-filter[aria-pressed="true"]{ background:#3a2a00; border-color:#f59e0b; color:#fcd34d; }

  /* --- Nye visuelle grep for filterbaren --- */
  .filterbar .divider { width:1px; height:22px; background:#e5e7eb; }
  html.dark .filterbar .divider { background:#1f2a44; }
  .filter-heading{
    display:inline-flex; align-items:center; gap:8px;
    padding:4px 10px; border-radius:999px;
    background:#f8fafc; border:1px solid #e5e7eb; color:#0f172a;
    font-weight:600; white-space:nowrap;
  }
  html.dark .filter-heading{ background:#0b1325; border-color:#1f2a44; color:#e5e7eb; }
  .badge{
    display:inline-flex; align-items:center; justify-content:center;
    min-width:22px; height:22px; padding:0 6px; border-radius:999px;
    background:#e5f0ff; border:1px solid #bfdbfe; font-size:.8rem; font-weight:700;
  }
  html.dark .badge{ background:#0f1c36; border-color:#26497a; }
  /* outline vs fylt chips (ny stil justert over eksisterende) */
  .chip { background:#fff; border:1px solid #d1d5db; color:#0f172a; }
  .chip[aria-pressed="true"]{ background:#e5effe; border-color:#93c5fd; color:#0c4a6e; }
  html.dark .chip{ background:#0b1325; border-color:#1f2a44; color:#e5e7eb; }
  html.dark .chip[aria-pressed="true"]{ background:#1f263a; border-color:#334155; color:#cfe1ff; }
  .price-compact .pill{
    display:inline-flex; align-items:center; gap:6px; background:#f8fafc; border:1px solid #e5e7eb;
    padding:2px 8px; border-radius:999px; font-variant-numeric: tabular-nums;
  }
  html.dark .price-compact .pill{ background:#0b1325; border-color:#1f2a44; }
  .reset-link{ color:#64748b; text-decoration:underline; cursor:pointer; font-size:.9rem; }
  .reset-link:hover{ color:#0c4a6e; }
  
  /* gjør sliders mer stabile på touch */
.price-compact input[type="range"] {
  touch-action: none;
}
  #resetFilters{ display:none !important; }
</style>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-7BTGNR2NXT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-7BTGNR2NXT');
</script>
</head>
<body>

<!-- HERO -->
<section class="hero" id="top">
  <div class="hero-inner">
    <div class="brand">
      <img src="logo.png" alt="Eliteheimen logo" />
      <div class="brand-title-row">
        <h1>Eliteheimen Fantasy</h1>
        <div class="brand-links">
          <a class="nav-link" href="https://eliteheimen.no/om/" aria-label="Om Eliteserien Fantasy">Om Eliteserien Fantasy</a>
          <a class="nav-link" href="https://patreon.com/Eliteheimen" target="_blank" rel="noopener" aria-label="Støtt på Patreon">Patreon</a>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <div id="last-updated"></div>
      <a id="downloadCsvBtn" class="download-btn" href="#" role="button">⬇️ Last ned CSV</a>
      <label class="toggle"><input type="checkbox" id="darkToggle"> Mørk modus</label>
    </div>
  </div>
</section>

<!-- FILTERBAR (NY layout) -->
<section id="filters" class="filterbar">
  <!-- Rad 1: primærfiltre -->
  <div class="filterbar-row">
    <!-- Favorittfilter-ikon -->
    <button id="favFilter" class="fav-filter" title="Vis kun favoritter" aria-pressed="false"></button>

    <!-- Søk -->
    <input id="q" type="search" placeholder="Søk i spillere…" aria-label="Globalt søk" />

    <span class="divider"></span>

    <!-- Posisjoner -->
    <span class="label">Posisjoner</span>
    <button class="chip" id="pos-all" aria-pressed="true">Alle</button>
    <div id="pos-chips" class="row microgap" style="margin:0;"></div>

    <span class="divider"></span>

    <!-- Klubb -->
    <span class="label" id="clubLabel">Klubb</span>
    <select id="clubSelect"><option value="">Alle</option></select>

    <span class="divider"></span>

    <!-- Pris -->
    <span class="label">Pris ≤</span>
    <div id="price-compact" class="price-compact" style="display:none;">
      <input id="priceCapRange" type="range" step="0.1" />
      <span class="pill"><span id="priceCapLabel"></span></span>
    </div>

    <!-- Nullstill (automatisk synlighet) -->
    <span id="resetFilters" class="reset-link" style="margin-left:auto; display:none;">Nullstill</span>
  </div>

  <!-- Rad 2: runde-chips for TOTALT -->
  <div class="filterbar-row" style="margin-top:6px;">
  <div id="totalChipsWrap" class="row" aria-label="Velg runder som skal inngå i TOTALT"></div>
</div>
</section>

<!-- TABELL -->
<section id="table" class="table-wrap" aria-labelledby="top">
  <table id="tbl" aria-describedby="q">
    <thead id="thead"></thead>
    <tbody id="tbody"></tbody>
  </table>
</section>

<!-- FOOTER -->
<footer class="footer-wrap" id="about">
  <div>© 2025 Eliteheimen.</div>
  <div>
    <a href="https://github.com/93pejoh/eliteheimen-data" target="_blank" rel="noopener">GitHub</a>
    &nbsp;•&nbsp;<a href="#top">Til toppen ↑</a>
  </div>
</footer>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
/* ================== KONFIG ================== */
const CSV_URL = "https://raw.githubusercontent.com/93pejoh/eliteheimen-data/refs/heads/main/data.csv";
window.CSV_URL = CSV_URL;

/* Skjul kolonner etter Excel-bokstav (indeksbasert) */
const HIDE_BY_LETTER = ["F","H","J","L","N","P","R"];

/* Runde-kolonner og TOTALT */
const GROUP_COLUMNS = ["R25","R26","R27","R28","R29","R30"];
const TOTAL_COLUMN  = "TOTALT";

/* ================== ELEMENTER ================== */
const thead=document.getElementById('thead'), tbody=document.getElementById('tbody');
const q=document.getElementById('q');
const posChipsWrap=document.getElementById('pos-chips'), posAllBtn=document.getElementById('pos-all');
const priceCompactWrap=document.getElementById('price-compact');
const priceCapRange=document.getElementById('priceCapRange'), priceCapLabel=document.getElementById('priceCapLabel');
const clubSelect=document.getElementById('clubSelect'), clubLabel=document.getElementById('clubLabel');
const miniKPI=document.getElementById('kpi-count-mini');
const totalChipsWrap=document.getElementById('totalChipsWrap');
const roundCountBadge=document.getElementById('roundCountBadge');
const resetFiltersEl=document.getElementById('resetFilters');
const favFilterBtn=document.getElementById('favFilter');

/* ================== STATE ================== */
let RAW_COLUMNS=[], VISIBLE_COLUMNS=[], DATA=[];
let sortCol=null, sortDir=1;
let activePositions=new Set();
let detectedPositionCol="", detectedNameCol="", detectedPriceCol="", detectedClubCol="", detectedXMinCol="";
let priceGlobalMin=null, priceGlobalMax=null, priceCapVal=null;
let selectedClub="";
let favoritesOnly = false;

/* TOTALT-innstillinger (persist) */
const TOTAL_KEY = 'eh_total_cols_v1';
let INCLUDED_IN_TOTAL = new Set(JSON.parse(localStorage.getItem(TOTAL_KEY) || '[]'));
if (INCLUDED_IN_TOTAL.size === 0) INCLUDED_IN_TOTAL = new Set(GROUP_COLUMNS);

/* Favoritter (persist) */
const FAVORITES_KEY = 'eh_favorites_v1';
let FAVORITES = new Set(JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]'));

/* ================== UTILS ================== */
function letterToIndex(letter){const s=letter.trim().toUpperCase();let n=0;for(let i=0;i<s.length;i++)n=n*26+(s.charCodeAt(i)-64);return n-1;}
function isNumericLike(v){if(v==null)return false;if(typeof v==="number")return true;const t=String(v).trim();if(t==='')return false;
  if(t.endsWith('%'))return !isNaN(Number(t.slice(0,-1).replace(',','.')));
  return !isNaN(Number(t.replace(/\s/g,'').replace(/kr/i,'').replace(',','.')));}
function toNumber(v){if(typeof v==="number")return v;const t=String(v).trim().replace(/\s/g,'').replace(/kr/i,'');if(t.endsWith('%'))return Number(t.slice(0,-1).replace(',','.'));return Number(t.replace(',','.'));}
function cmp(a,b){const an=isNumericLike(a),bn=isNumericLike(b);if(an&&bn)return toNumber(a)-toNumber(b);return String(a).localeCompare(String(b),'no',{numeric:true,sensitivity:'base'});}
function detectInsensitive(cols,wantedLower){const lower=cols.map(c=>c.toLowerCase());const i=lower.indexOf(wantedLower);return i>=0?cols[i]:"";}
const fmtInt=n=>new Intl.NumberFormat('no-NO',{maximumFractionDigits:0}).format(n);
const fmt2=n=>new Intl.NumberFormat('no-NO',{minimumFractionDigits:2, maximumFractionDigits:2}).format(n);

/* Favoritter */
function favKeyFromRow(row){
  const name = detectedNameCol ? String(row[detectedNameCol] ?? '') : '';
  const club = detectedClubCol ? String(row[detectedClubCol] ?? '') : '';
  return `${name}::${club}`;
}
function isFavKey(k){ return FAVORITES.has(k); }
function toggleFavKey(k){ if(FAVORITES.has(k)) FAVORITES.delete(k); else FAVORITES.add(k);
  localStorage.setItem(FAVORITES_KEY, JSON.stringify([...FAVORITES])); }

/* Fargeskala */
function luminance(rgb){const s=rgb.map(v=>{v/=255;return v<=0.03928?v/12.92:Math.pow((v+0.055)/1.055,2.4);});return 0.2126*s[0]+0.7152*s[1]+0.0722*s[2];}
function colorGroup(val,min,max){
  if(!isNumericLike(val))return '';
  const x=toNumber(val); if(!isFinite(x)||!isFinite(min)||!isFinite(max)||max<=min)return '';
  const mid=3; let r,g,b;
  if (x<=mid){ const t=(x-min)/(mid-min); r=Math.round(0xd2+(0xff-0xd2)*t); g=Math.round(0x25+(0xff-0x25)*t); b=Math.round(0x5d+(0xff-0x5d)*t); }
  else        { const t=(x-mid)/(max-mid); r=Math.round(0xff+(0x04-0xff)*t); g=Math.round(0xff+(0xb1-0xff)*t); b=Math.round(0xff+(0x55-0xff)*t); }
  const text=luminance([r,g,b])<0.55?'#fff':'#000';
  return `background:rgb(${r}, ${g}, ${b}) !important;color:${text} !important;`;
}
function colorTotalBlue(val,min,max){
  if(!isNumericLike(val))return '';
  const x=toNumber(val); if(!isFinite(x)||!isFinite(min)||!isFinite(max)||max<=min)return '';
  const t=(x-min)/(max-min); const hue=210, sat=90, light=92 - t*32;
  return `background:hsl(${hue} ${sat}% ${light}% ) !important;color:#000 !important;`;
}
function computeGroupRange(rows, cols){
  let min=Infinity, max=-Infinity, any=false;
  for(const r of rows){for(const c of cols){const v=r[c];
    if(isNumericLike(v)){const n=toNumber(v);if(isFinite(n)){any=true;if(n<min)min=n;if(n>max)max=n;}}
  }}
  return any && max>min ? {min,max} : null;
}
function computeSingleRange(rows, col){
  let min=Infinity, max=-Infinity, any=false;
  for(const r of rows){const v=r[col];
    if(isNumericLike(v)){const n=toNumber(v);if(isFinite(n)){any=true;if(n<min)min=n;if(n>max)max=n;}}
  }
  return any && max>min ? {min,max} : null;
}

/* ================== UI BYGG ================== */
function renderHeader(){
  const tr=document.createElement('tr');
  VISIBLE_COLUMNS.forEach(col=>{
    const th=document.createElement('th');
    const btn=document.createElement('button');
    btn.textContent=col;
    btn.addEventListener('click',()=>{if(sortCol===col)sortDir*=-1;else{sortCol=col;sortDir=1;}render();});
    th.appendChild(btn);
    if (sortCol===col){const s=document.createElement('span');s.className='sort-ind';s.textContent=sortDir===1?'▲':'▼';th.appendChild(s);}
    tr.appendChild(th);
  });
  thead.innerHTML=''; thead.appendChild(tr);
}

function buildPositionChips(data, col){
  posChipsWrap.innerHTML='';
  posAllBtn.setAttribute('aria-pressed', activePositions.size===0 ? 'true' : 'false');
  if(!col){posAllBtn.disabled=true;return;} posAllBtn.disabled=false;

  const seen=new Set(), values=[];
  for(const r of data){const v=String(r[col]??'').trim(); if(v && !seen.has(v)){seen.add(v);values.push(v);}}
  const order=["K","F","M","A","GK","DEF","MID","FWD","Keeper","Forsvar","Midtbane","Angrep"];
  values.sort((a,b)=>{const ia=order.indexOf(a),ib=order.indexOf(b);
    if(ia!==-1&&ib!==-1)return ia-ib; if(ia!==-1)return -1; if(ib!==-1)return 1;
    return a.localeCompare(b,'no',{numeric:true});});

  for(const val of values){
    const btn=document.createElement('button');
    btn.className='chip'; btn.textContent=val; btn.setAttribute('aria-pressed', activePositions.has(val)?'true':'false');
    btn.addEventListener('click',()=>{
      posAllBtn.setAttribute('aria-pressed','false');
      if(activePositions.has(val)) activePositions.delete(val); else activePositions.add(val);
      if(activePositions.size===0) posAllBtn.setAttribute('aria-pressed','true');
      btn.setAttribute('aria-pressed', activePositions.has(val)?'true':'false');
      render();
    });
    posChipsWrap.appendChild(btn);
  }
  posAllBtn.onclick=()=>{
    activePositions.clear();
    posAllBtn.setAttribute('aria-pressed','true');
    [...posChipsWrap.querySelectorAll('.chip')].forEach(ch=>ch.setAttribute('aria-pressed','false'));
    render();
  };
}

function buildClubSelect(data, col){
  if (!clubSelect || !clubLabel) return;
  if (!col){ clubSelect.style.display="none"; clubLabel.style.display="none"; return; }

  const seen=new Set(), values=[];
  for (const r of data){
    const v=String(r[col]??'').trim();
    if (v && !seen.has(v)){ seen.add(v); values.push(v); }
  }
  values.sort((a,b)=> a.localeCompare(b,'no',{numeric:true,sensitivity:'base'}));
  clubSelect.innerHTML = `<option value="">Alle</option>` + values.map(v=>`<option value="${v}">${v}</option>`).join('');
  clubSelect.onchange = ()=>{ selectedClub = clubSelect.value || ""; render(); };
}

/* KPI */
function updateKPIs(rows){
  if (miniKPI) miniKPI.textContent = `${fmtInt(rows.length)} spillere`;
}

/* Pris */
function computePriceRange(rows,col){
  let min=Infinity,max=-Infinity,any=false;
  for(const r of rows){const v=r[col];
    if(isNumericLike(v)){const n=toNumber(v);if(isFinite(n)){any=true;if(n<min)min=n;if(n>max)max=n;}}
  }
  return any?{min,max}:null;
}
  
function setupPriceCompact(){
  detectedPriceCol = detectPriceColumn(RAW_COLUMNS);
  if(!detectedPriceCol){
    priceCompactWrap.style.display = 'none';
    return;
  }

  const r = computePriceRange(DATA, detectedPriceCol);
  if(!r){
    priceCompactWrap.style.display = 'none';
    return;
  }

  priceGlobalMin = r.min;
  priceGlobalMax = r.max;
  priceCapVal    = priceGlobalMax;

  priceCapRange.min  = priceGlobalMin.toFixed(1);
  priceCapRange.max  = priceGlobalMax.toFixed(1);
  priceCapRange.step = 0.1;
  priceCapRange.value = priceCapVal.toFixed(1);
  priceCapLabel.textContent = priceCapVal.toFixed(1).replace('.', ',');

  priceCompactWrap.style.display = 'inline-flex';

  // ← original adferd: oppdater og render for hvert input
  priceCapRange.addEventListener('input', () => {
    priceCapVal = Number(priceCapRange.value);
    priceCapLabel.textContent = priceCapVal.toFixed(1).replace('.', ',');
    render();
  });
}

/* ================== TOTALT ================== */
function updateRoundCountBadge(){
  if (!roundCountBadge) return;
  roundCountBadge.textContent = `${INCLUDED_IN_TOTAL.size}/${GROUP_COLUMNS.length}`;
}
function buildTotalChips(){
  if (!totalChipsWrap) return;
  totalChipsWrap.innerHTML = '';
  for (const col of GROUP_COLUMNS){
    const btn = document.createElement('button');
    btn.className = 'chip';
    btn.type = 'button';
    btn.textContent = col;

    const on = INCLUDED_IN_TOTAL.has(col);
    btn.setAttribute('aria-pressed', on ? 'true' : 'false');
    btn.title = on ? 'Klikk for å ekskludere fra TOTALT' : 'Klikk for å inkludere i TOTALT';

    btn.addEventListener('click', ()=>{
      if (INCLUDED_IN_TOTAL.has(col)) INCLUDED_IN_TOTAL.delete(col);
      else INCLUDED_IN_TOTAL.add(col);

      localStorage.setItem(TOTAL_KEY, JSON.stringify([...INCLUDED_IN_TOTAL]));
      buildTotalChips();
      computeTotalsForData();
      rebuildVisibleColumns();   // <- skjul/vis kolonner umiddelbart
      render();
    });

    totalChipsWrap.appendChild(btn);
  }
  updateRoundCountBadge();
}

function computeTotalForRow(row){
  let sum = 0; let any=false;
  INCLUDED_IN_TOTAL.forEach(c=>{
    const v = row[c];
    if (isNumericLike(v)){ sum += toNumber(v); any=true; }
  });
  return any ? Math.round(sum*100)/100 : '';
}
function computeTotalsForData(){ for (const r of DATA){ r[TOTAL_COLUMN] = computeTotalForRow(r); } }

/* Synlige kolonner */
function rebuildVisibleColumns(){
  const hideIdx=new Set(HIDE_BY_LETTER.map(letterToIndex));
  const base=[]; RAW_COLUMNS.forEach((c,i)=>{ if(!hideIdx.has(i)) base.push(c); });

  const idxN6 = base.indexOf('NESTE 6'); if (idxN6 !== -1) base.splice(idxN6,1);

  // Skjul ekskluderte runder ALLTID
  let cols = base.filter(c => !(GROUP_COLUMNS.includes(c) && !INCLUDED_IN_TOTAL.has(c)));

  // Sett inn TOTALT rett etter xMin (case-insensitivt), ellers på slutten
  cols = cols.filter(c => c !== TOTAL_COLUMN);
  const xMinCol = detectedXMinCol;
  const insertAfterIndex = xMinCol ? cols.indexOf(xMinCol) : -1;
  if (insertAfterIndex >= 0){ cols.splice(insertAfterIndex+1, 0, TOTAL_COLUMN); }
  else { cols.push(TOTAL_COLUMN); }

  // Flytt NAVN først
  if (detectedNameCol){
    const i=cols.indexOf(detectedNameCol);
    if(i>0){ cols.splice(i,1); cols.unshift(detectedNameCol); }
  }
  VISIBLE_COLUMNS = cols;
}

/* Nullstill-lenke synlighet */
function updateResetLinkVisibility(){ /* deaktivert */ }

/* ================== RENDER ================== */
function render(){
  renderHeader();
  let rows=DATA.filter(row=>{
    const query=(q?.value||'').toLowerCase();
    if (query){
      const hit=VISIBLE_COLUMNS.some(c=>String(row[c]??'').toLowerCase().includes(query));
      if(!hit)return false;
    }
    if (detectedPositionCol && activePositions.size>0){
      const pv=String(row[detectedPositionCol]??'').trim();
      if (!activePositions.has(pv)) return false;
    }
    if (detectedClubCol && selectedClub){
      const cv=String(row[detectedClubCol]??'').trim();
      if (cv !== selectedClub) return false;
    }
    if (detectedPriceCol && priceCapVal!=null){
      const v=row[detectedPriceCol];
      if(!isNumericLike(v))return false;
      if(toNumber(v)>priceCapVal)return false;
    }
    if (favoritesOnly){
      const key = favKeyFromRow(row);
      if (!isFavKey(key)) return false;
    }
    return true;
  });

  if (sortCol) rows.sort((a,b)=>sortDir*cmp(a[sortCol], b[sortCol]));

  const groupRange  = computeGroupRange(rows, GROUP_COLUMNS);
  const totalRange  = VISIBLE_COLUMNS.includes(TOTAL_COLUMN) ? computeSingleRange(rows, TOTAL_COLUMN) : null;

  tbody.innerHTML='';
  const frag=document.createDocumentFragment();
  for (const row of rows){
    const tr=document.createElement('tr');
    tr.innerHTML = VISIBLE_COLUMNS.map(c=>{
      let style='';
      if (GROUP_COLUMNS.includes(c) && groupRange){
        style = colorGroup(row[c], groupRange.min, groupRange.max);
      } else if (c === TOTAL_COLUMN && totalRange){
        style = colorTotalBlue(row[c], totalRange.min, totalRange.max);
      }
      let val = row[c] ?? '';

      // Posisjons-badge
      if (detectedPositionCol && c === detectedPositionCol){
        const pos = String(val);
        const bg = pos==="K"?"#E0F2FE":pos==="F"?"#DCFCE7":pos==="M"?"#FEF9C3":pos==="A"?"#FFE4E6":"#F2F4F7";
        val = `<span class="pos-badge" style="background:${bg};">${pos}</span>`;
      }

      // TOTALT i bold 2 desimaler
      if (c === TOTAL_COLUMN){
        const num = isNumericLike(val) ? toNumber(val) : null;
        val = `<strong>${(num!=null && isFinite(num)) ? fmt2(num) : ''}</strong>`;
      }

      // Navn med favoritt-stjerne
      if (detectedNameCol && c === detectedNameCol){
        const key = favKeyFromRow(row);
        const pressed = isFavKey(key);
        const label = pressed ? 'Fjern favoritt' : 'Marker som favoritt';
        const starBtn = `<button class="fav-btn" type="button" aria-label="${label}" aria-pressed="${pressed}" data-favkey="${key}">
                           <span class="star" aria-hidden="true"></span>
                         </button>`;
        val = `<div class="name-cell">${starBtn}<strong>${row[c] ?? ''}</strong></div>`;
      }

      const cellStyle = style ? ` style="${style}"` : "";
      return `<td${cellStyle}>${val}</td>`;
    }).join('');
    frag.appendChild(tr);
  }
  tbody.appendChild(frag);
  updateKPIs(rows);
  updateRoundCountBadge();
  updateResetLinkVisibility();
}

/* ================== INIT ================== */
function detectPositionColumn(columns){
  const cands=["posisjon","position","pos","rolle","role"];
  const lower=columns.map(c=>c.toLowerCase());
  for(let i=0;i<lower.length;i++) if(cands.includes(lower[i])) return columns[i];
  return "";
}
function detectPriceColumn(columns){
  const prefs=["pris","price","kostnad","cost"];
  const lower=columns.map(c=>c.toLowerCase());
  for(let i=0;i<lower.length;i++) if(prefs.includes(lower[i])) return columns[i];
  return "";
}
function detectClubColumn(columns){
  const cands=["klubb","lag","team","club"];
  const lower=columns.map(c=>c.toLowerCase());
  for(let i=0;i<lower.length;i++) if(cands.includes(lower[i])) return columns[i];
  return "";
}

(function start(){
  // Favorittfilter-knapp
  if (favFilterBtn){
    favFilterBtn.addEventListener('click', ()=>{
      favoritesOnly = !(favFilterBtn.getAttribute('aria-pressed') === 'true');
      favFilterBtn.setAttribute('aria-pressed', favoritesOnly ? 'true' : 'false');
      render();
    });
  }

  q?.addEventListener('input', render);

  Papa.parse(CSV_URL,{
    download:true,header:true,dynamicTyping:true,skipEmptyLines:'greedy',
    complete:(res)=>{
      try{
        const data=res.data||[];
        RAW_COLUMNS=(res.meta && res.meta.fields && res.meta.fields.length)?res.meta.fields:(data[0]?Object.keys(data[0]):[]);
        if (!RAW_COLUMNS || RAW_COLUMNS.length===0) throw new Error("Fant ingen kolonner i CSV");

        detectedPositionCol=detectPositionColumn(RAW_COLUMNS);
        detectedNameCol=detectInsensitive(RAW_COLUMNS,"navn");
        detectedClubCol=detectClubColumn(RAW_COLUMNS);
        detectedXMinCol=detectInsensitive(RAW_COLUMNS,"xmin");

        DATA=data.map(r=>{const o={}; RAW_COLUMNS.forEach(c=>o[c]=r[c]??'' ); return o;});

        buildPositionChips(DATA, detectedPositionCol);
        buildClubSelect(DATA, detectedClubCol);
        setupPriceCompact();

        computeTotalsForData();
        rebuildVisibleColumns();
        buildTotalChips();

        render();
      }catch(err){
        console.error(err);
        thead.innerHTML='<tr><th class="error">Feil i data/JS</th></tr>';
        tbody.innerHTML=`<tr><td>Kunne ikke bygge tabell: ${String(err.message||err)}</td></tr>`;
      }
    },
    error:(err)=>{
      console.error(err);
      thead.innerHTML='<tr><th class="error">Feil: kunne ikke laste CSV</th></tr>';
      tbody.innerHTML='<tr><td>Sjekk at CSV_URL er tilgjengelig.</td></tr>';
    }
  });
})();
</script>


<!-- EGEN SCRIPT FOR "SIST OPPDATERT" -->
<script>
(() => {
  const meta = document.querySelector('meta[name="data-last-updated"]');
  let last = meta?.content ? new Date(meta.content) : new Date(document.lastModified);
  const fmt = new Intl.DateTimeFormat('nb-NO', { dateStyle:'long', timeStyle:'short' });
  const el = document.getElementById('last-updated');
  if (el) {
    el.textContent = `Sist oppdatert: ${fmt.format(last)}`;
    el.title = last.toISOString();
  }
})();
</script>

<!-- TVING LOKAL NEDLASTING AV CSV (fetch + Blob) -->
<script>
(() => {
  const btn = document.getElementById('downloadCsvBtn');
  if (!btn) return;

  async function downloadCsv() {
    try {
      btn.textContent = "Laster ned…";
      btn.setAttribute('aria-busy', 'true');

      const res = await fetch(window.CSV_URL || "https://raw.githubusercontent.com/93pejoh/eliteheimen-data/refs/heads/main/data.csv", { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const blob = await res.blob();

      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'data.csv'; // lokalt filnavn
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    } catch (err) {
      // Fallback: åpne rålenken hvis fetch feiler
      window.open(window.CSV_URL || "https://raw.githubusercontent.com/93pejoh/eliteheimen-data/refs/heads/main/data.csv", '_blank');
    } finally {
      btn.textContent = "⬇️ Last ned CSV";
      btn.removeAttribute('aria-busy');
    }
  }

  btn.addEventListener('click', (e) => {
    e.preventDefault(); // ikke naviger
    downloadCsv();
  });
})();
</script>
</body>
</html>
