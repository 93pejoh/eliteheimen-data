<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Eliteheimen – runde 23</title>
<meta name="description" content="Tabell med posisjonsfilter, sortering og målrettet betinget formatering." />
<style>
  :root { --radius: 12px; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, Noto Sans, sans-serif; margin: 24px; }
  h1 { font-size: 1.5rem; margin: 0 0 .25rem; }
  .sub { color: #555; margin-bottom: 1rem; }
  .controls { display: grid; grid-template-columns: 1fr auto auto auto; gap: 8px; align-items: center; margin-bottom: 12px; }
  input[type="search"] { padding: 10px 12px; border: 1px solid #ccc; border-radius: var(--radius); outline: none; }
  input[type="search"]:focus { border-color: #888; }
  button { padding: 8px 12px; border: 1px solid #ddd; border-radius: var(--radius); background: #fff; cursor: pointer; }
  label.switch { display: inline-flex; align-items: center; gap: 8px; user-select: none; }
  .pill { border: 1px solid #e0e0e0; border-radius: 999px; padding: 6px 10px; background: #fff; }
  .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
  .chip { border: 1px solid #ddd; border-radius: 999px; padding: 6px 10px; background: #fff; cursor: pointer; user-select: none; }
  .chip[aria-pressed="true"] { outline: 2px solid #444; }
  .table-wrap { overflow: auto; border: 1px solid #e5e5e5; border-radius: var(--radius); }
  table { border-collapse: collapse; width: 100%; font-size: 0.95rem; }
  thead th { position: sticky; top: 0; background: #fafafa; border-bottom: 1px solid #e5e5e5; text-align: left; padding: 10px; white-space: nowrap; }
  tbody td { border-top: 1px solid #f0f0f0; padding: 8px 10px; vertical-align: top; white-space: nowrap; }
  thead th button { background: transparent; border: none; font: inherit; cursor: pointer; }
  .sort-ind { opacity: .6; font-size: .9em; margin-left: 6px; }
  .legend { font-size: .9rem; color: #666; }
  .footer { margin-top: 16px; font-size: .9rem; color: #666; }
  .error { color: #b00020; }
  .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
</style>
</head>
<body>
  <h1>Eliteheimen – runde 23</h1>
  <div class="sub">Posisjonsfilter, sortering og målrettet fargelegging (R23–R28 sammen; “Neste 6” egen skala).</div>

  <!-- Rad 1: Globalt søk, teller, betinget formatering, nullstill -->
  <div class="controls" role="region" aria-label="Kontroller">
    <input id="q" type="search" placeholder="Søk i synlige kolonner…" aria-label="Globalt søk" />
    <div class="pill"><span id="shown">0</span>/<span id="total">0</span> rader</div>
    <label class="switch" title="Skru av/på fargelegging">
      <input type="checkbox" id="condfmt" checked /> Betinget formatering
    </label>
    <button id="reset" type="button">Nullstill</button>
  </div>

  <!-- Rad 2: Posisjonsfilter -->
  <div class="row" role="region" aria-label="Posisjonsfilter">
    <strong>Posisjoner:</strong>
    <button class="chip" id="pos-all" aria-pressed="true">Alle</button>
    <div id="pos-chips" class="row" style="margin:0;"></div>
  </div>

  <div id="status" aria-live="polite" class="sr-only"></div>
  <div class="table-wrap">
    <table id="tbl" aria-describedby="q">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="legend">Fargeskala: lav verdi → lys rød, høy verdi → lys grønn. R23–R28 deler skala; “Neste 6” har egen.</div>

  <div class="footer">
    Kilde: <code>https://raw.githubusercontent.com/93pejoh/eliteheimen-data/refs/heads/main/Eliteheimen%20%E2%80%93%20runde%2023.csv</code>.
  </div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
  // ===================== KONFIG =====================
  const CSV_URL = "https://raw.githubusercontent.com/93pejoh/eliteheimen-data/refs/heads/main/Eliteheimen%20%E2%80%93%20runde%2023.csv";

  // Skjul disse kolonnene etter Excel-bokstav:
  const HIDE_BY_LETTER = ["F","H","J","L","N","P","R"];

  // (Valgfritt) Skjul også etter eksakt kolonnenavn:
  const HIDE_COLUMNS = [];

  // Posisjonskolonne (tom = autodetekter case-insensitive):
  let POSITION_COLUMN = "";

  // Betinget formatering: grupper
  const GROUP_COLUMNS = ["R23","R24","R25","R26","R27","R28"]; // felles skala
  const NESTE6_COLUMN = "Neste 6";                              // isolert skala

  // (Valgfritt) Inverter skala for disse (lavere er bedre):
  const INVERT_COLOR_COLUMNS = []; // f.eks. ["Pris", "R23"]

  // Søk bare i synlige kolonner
  const SEARCH_VISIBLE_ONLY = true;
  // ==================================================

  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const q = document.getElementById('q');
  const shownEl = document.getElementById('shown');
  const totalEl = document.getElementById('total');
  const resetBtn = document.getElementById('reset');
  const statusEl = document.getElementById('status');
  const posChipsWrap = document.getElementById('pos-chips');
  const posAllBtn = document.getElementById('pos-all');
  const condfmtToggle = document.getElementById('condfmt');

  let RAW_COLUMNS = [];
  let VISIBLE_COLUMNS = [];
  let DATA = [];
  let sortCol = null;
  let sortDir = 1;
  let activePositions = new Set(); // tom = alle
  let detectedPositionCol = ""; // faktisk brukt navn

  function setStatus(msg){ statusEl.textContent = msg || ''; }

  // ===== utils =====
  function letterToIndex(letter){ const s=letter.trim().toUpperCase(); let n=0; for(let i=0;i<s.length;i++) n=n*26+(s.charCodeAt(i)-64); return n-1; }
  function isNumericLike(val){
    if (val===null || val===undefined) return false;
    if (typeof val==='number') return true;
    const t=String(val).trim();
    if (t==='') return false;
    if (t.endsWith('%')) return !isNaN(Number(t.slice(0,-1).replace(',','.')));
    return !isNaN(Number(t.replace(',','.')));
  }
  function toNumber(val){
    if (typeof val==='number') return val;
    const t=String(val).trim();
    if (t.endsWith('%')) return Number(t.slice(0,-1).replace(',','.'));
    return Number(t.replace(',','.'));
  }
  function cmp(a,b){ const an=isNumericLike(a), bn=isNumericLike(b); if(an&&bn) return toNumber(a)-toNumber(b); return String(a).localeCompare(String(b),'no',{numeric:true,sensitivity:'base'}); }

  // ===== header (kun sortering) =====
  function renderHeader(){
    const tr=document.createElement('tr');
    VISIBLE_COLUMNS.forEach(col=>{
      const th=document.createElement('th');
      const btn=document.createElement('button');
      btn.textContent=col;
      btn.addEventListener('click',()=>{ if(sortCol===col) sortDir*=-1; else { sortCol=col; sortDir=1; } render(); });
      th.appendChild(btn);
      if (sortCol===col){ const s=document.createElement('span'); s.className='sort-ind'; s.textContent=sortDir===1?'▲':'▼'; th.appendChild(s); }
      tr.appendChild(th);
    });
    thead.innerHTML=''; thead.appendChild(tr);
  }

  // ===== filtrering =====
  function rowMatches(row){
    const query=(q.value||'').toLowerCase();
    if (query){
      const cols = SEARCH_VISIBLE_ONLY ? VISIBLE_COLUMNS : RAW_COLUMNS;
      const hit = cols.some(c => String(row[c]??'').toLowerCase().includes(query));
      if (!hit) return false;
    }
    if (detectedPositionCol && activePositions.size>0){
      const pv=String(row[detectedPositionCol]??'').trim();
      if (!activePositions.has(pv)) return false;
    }
    return true;
  }

  // ===== betinget formatering =====
  function valueColor(val, min, max, invert=false){
    if (!isNumericLike(val)) return '';
    const x=toNumber(val); if(!isFinite(x) || !isFinite(min) || !isFinite(max) || max<=min) return '';
    let t=(x-min)/(max-min); if (invert) t=1-t;
    const hue = 0 + t*120; // 0=rød → 120=grønn
    return `background: hsl(${hue} 80% 92%)`;
  }

  // Finn felles min/max over R23–R28 på de synlige radene
  function computeGroupRange(rows, cols){
    let min=Infinity, max=-Infinity, any=false;
    for (const r of rows){
      for (const c of cols){
        const v=r[c];
        if (isNumericLike(v)){
          const num=toNumber(v);
          if (isFinite(num)){ any=true; if (num<min) min=num; if (num>max) max=num; }
        }
      }
    }
    return any && max>min ? {min, max} : null;
  }

  // Finn min/max for “Neste 6” på de synlige radene
  function computeSingleRange(rows, col){
    let min=Infinity, max=-Infinity, any=false;
    for (const r of rows){
      const v=r[col];
      if (isNumericLike(v)){
        const num=toNumber(v);
        if (isFinite(num)){ any=true; if (num<min) min=num; if (num>max) max=num; }
      }
    }
    return any && max>min ? {min, max} : null;
  }

  // ===== render =====
  function render(){
    renderHeader();
    let rows = DATA.filter(rowMatches);
    if (sortCol) rows.sort((a,b)=>sortDir*cmp(a[sortCol], b[sortCol]));

    // Ranges basert på synlige rader
    const groupRange  = condfmtToggle.checked ? computeGroupRange(rows, GROUP_COLUMNS) : null;
    const neste6Range = condfmtToggle.checked ? computeSingleRange(rows, NESTE6_COLUMN) : null;

    // bygg tabell
    tbody.innerHTML='';
    const frag=document.createDocumentFragment();
    for (const row of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = VISIBLE_COLUMNS.map(c=>{
        let style='';
        if (condfmtToggle.checked){
          if (GROUP_COLUMNS.includes(c) && groupRange){
            style = valueColor(row[c], groupRange.min, groupRange.max, INVERT_COLOR_COLUMNS.includes(c));
          } else if (c===NESTE6_COLUMN && neste6Range){
            style = valueColor(row[c], neste6Range.min, neste6Range.max, INVERT_COLOR_COLUMNS.includes(c));
          }
        }
        const val=row[c]??'';
        return `<td style="${style}">${val}</td>`;
      }).join('');
      frag.appendChild(tr);
    }
    tbody.appendChild(frag);
    shownEl.textContent=String(rows.length);
    totalEl.textContent=String(DATA.length);
  }

  // ===== posisjoner =====
  function detectPositionColumn(columns){
    if (POSITION_COLUMN && columns.includes(POSITION_COLUMN)) return POSITION_COLUMN;
    const cands=["posisjon","position","pos","rolle","role"];
    const lower=columns.map(c=>c.toLowerCase());
    for (let i=0;i<lower.length;i++) if (cands.includes(lower[i])) return columns[i];
    return "";
  }

  function buildPositionChips(data, colName){
    posChipsWrap.innerHTML='';
    posAllBtn.setAttribute('aria-pressed', activePositions.size===0 ? 'true' : 'false');
    if (!colName){ posAllBtn.disabled=true; return; }
    posAllBtn.disabled=false;

    const seen=new Set(), values=[];
    for (const r of data){ const v=String(r[colName]??'').trim(); if (v && !seen.has(v)){ seen.add(v); values.push(v); } }
    const order=["K","F","M","A","GK","DEF","MID","FWD","Keeper","Forsvar","Midtbane","Angrep"];
    values.sort((a,b)=>{const ia=order.indexOf(a),ib=order.indexOf(b); if(ia!==-1&&ib!==-1)return ia-ib; if(ia!==-1)return-1; if(ib!==-1)return 1; return a.localeCompare(b,'no',{numeric:true});});

    for (const val of values){
      const btn=document.createElement('button');
      btn.className='chip'; btn.textContent=val; btn.setAttribute('aria-pressed', activePositions.has(val)?'true':'false');
      btn.addEventListener('click',()=>{
        posAllBtn.setAttribute('aria-pressed','false');
        if (activePositions.has(val)) activePositions.delete(val); else activePositions.add(val);
        if (activePositions.size===0) posAllBtn.setAttribute('aria-pressed','true');
        btn.setAttribute('aria-pressed', activePositions.has(val)?'true':'false');
        render();
      });
      posChipsWrap.appendChild(btn);
    }
    posAllBtn.onclick=()=>{ activePositions.clear(); posAllBtn.setAttribute('aria-pressed','true'); [...posChipsWrap.querySelectorAll('.chip')].forEach(ch=>ch.setAttribute('aria-pressed','false')); render(); };
  }

  // ===== last data =====
  setStatus('Laster data…');
  Papa.parse(CSV_URL, {
    download:true, header:true, dynamicTyping:true, skipEmptyLines:'greedy',
    complete:(res)=>{
      setStatus('');
      if (res.errors && res.errors.length) console.warn('CSV parse errors:', res.errors);
      const data=res.data||[];

      RAW_COLUMNS = (res.meta && res.meta.fields && res.meta.fields.length) ? res.meta.fields : (data[0] ? Object.keys(data[0]) : []);
      const hideIdx=new Set(HIDE_BY_LETTER.map(letterToIndex));
      const hideName=new Set(HIDE_COLUMNS);
      VISIBLE_COLUMNS=[];
      RAW_COLUMNS.forEach((c,i)=>{ if(!hideIdx.has(i) && !hideName.has(c)) VISIBLE_COLUMNS.push(c); });

      detectedPositionCol = detectPositionColumn(RAW_COLUMNS);
      DATA = data.map(r=>{ const o={}; RAW_COLUMNS.forEach(c=>o[c]=r[c]??''); return o; });

      buildPositionChips(DATA, detectedPositionCol);
      totalEl.textContent=String(DATA.length);
      render();
    },
    error:(err)=>{ setStatus('Kunne ikke laste CSV. Se konsollen.'); console.error(err); thead.innerHTML='<tr><th class="error">Feil: kunne ikke laste CSV</th></tr>'; }
  });

  // ===== handlers =====
  q.addEventListener('input', render);
  condfmtToggle.addEventListener('change', render);
  resetBtn.addEventListener('click',()=>{
    q.value=''; sortCol=null; sortDir=1; activePositions.clear();
    posAllBtn.setAttribute('aria-pressed','true');
    [...posChipsWrap.querySelectorAll('.chip')].forEach(ch=>ch.setAttribute('aria-pressed','false'));
    render();
  });
</script>
</body>
</html>
