<!doctype html>
<html lang="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Eliteheimen – runde 23</title>
<meta name="description" content="Tabell med posisjonsfilter, sortering, bold NAVN og målrettet betinget formatering." />
<style>
  :root { --radius: 12px; }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, Noto Sans, sans-serif; margin: 24px; }
  h1 { font-size: 1.5rem; margin: 0 0 .25rem; }
  .sub { color: #555; margin-bottom: 1rem; }
  .controls { display: grid; grid-template-columns: 1fr auto auto auto; gap: 8px; align-items: center; margin-bottom: 12px; }
  input[type="search"] { padding: 10px 12px; border: 1px solid #ccc; border-radius: var(--radius); outline: none; }
  input[type="search"]:focus { border-color: #888; }
  button { padding: 8px 12px; border: 1px solid #ddd; border-radius: var(--radius); background: #fff; cursor: pointer; }
  label.switch { display: inline-flex; align-items: center; gap: 8px; user-select: none; }
  .pill { border: 1px solid #e0e0e0; border-radius: 999px; padding: 6px 10px; background: #fff; }
  .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 10px; }
  .chip { border: 1px solid #ddd; border-radius: 999px; padding: 6px 10px; background: #fff; cursor: pointer; user-select: none; }
  .chip[aria-pressed="true"] { outline: 2px solid #444; }
  .table-wrap { overflow: auto; border: 1px solid #e5e5e5; border-radius: var(--radius); }
  table { border-collapse: collapse; width: 100%; font-size: 0.95rem; }
  thead th { position: sticky; top: 0; background: #fafafa; border-bottom: 1px solid #e5e5e5; text-align: left; padding: 10px; white-space: nowrap; }
  tbody td { border-top: 1px solid #f0f0f0; padding: 8px 10px; vertical-align: top; white-space: nowrap; }
  thead th button { background: transparent; border: none; font: inherit; cursor: pointer; }
  .sort-ind { opacity: .6; font-size: .9em; margin-left: 6px; }
  .legend { font-size: .9rem; color: #666; }
  .footer { margin-top: 16px; font-size: .9rem; color: #666; }
  .error { color: #b00020; }
</style>
</head>
<body>
  <h1>Eliteheimen – runde 23</h1>
  <div class="sub">Bold NAVN, posisjonsfilter og målrettet fargelegging (R23–R28 felles rød→grønn • «NESTE 6» kraftig blå kontrast).</div>

  <div class="controls">
    <input id="q" type="search" placeholder="Søk i synlige kolonner…" />
    <div class="pill"><span id="shown">0</span>/<span id="total">0</span> rader</div>
    <label class="switch"><input type="checkbox" id="condfmt" checked /> Betinget formatering</label>
    <button id="reset" type="button">Nullstill</button>
  </div>

  <div class="row">
    <strong>Posisjoner:</strong>
    <button class="chip" id="pos-all" aria-pressed="true">Alle</button>
    <div id="pos-chips" class="row" style="margin:0;"></div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="legend">R23–R28: rød→grønn. NESTE 6: lys→mørk blå med sterk kontrast.</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
const CSV_URL = "https://raw.githubusercontent.com/93pejoh/eliteheimen-data/refs/heads/main/Eliteheimen%20%E2%80%93%20runde%2023.csv";
const HIDE_BY_LETTER = ["F","H","J","L","N","P","R"];
const GROUP_COLUMNS = ["R23","R24","R25","R26","R27","R28"];
const NESTE6_COLUMN = "NESTE 6";
const NAME_PREF = "navn";

let RAW_COLUMNS=[],VISIBLE_COLUMNS=[],DATA=[],sortCol=null,sortDir=1,activePositions=new Set(),detectedNameCol="",detectedPositionCol="";

function letterToIndex(l){const s=l.trim().toUpperCase();let n=0;for(let i=0;i<s.length;i++)n=n*26+(s.charCodeAt(i)-64);return n-1;}
function isNum(v){if(v===null||v===undefined)return false;if(typeof v==="number")return true;const t=String(v).trim();return t!==""&&!isNaN(Number(t.replace(",",".")));}
function toNum(v){if(typeof v==="number")return v;return Number(String(v).trim().replace(",","."));}
function cmp(a,b){const an=isNum(a),bn=isNum(b);if(an&&bn)return toNum(a)-toNum(b);return String(a).localeCompare(String(b),"no",{numeric:true});}
function detectInsensitive(cols,w){const lower=cols.map(c=>c.toLowerCase());const i=lower.indexOf(w);return i>=0?cols[i]:"";}
function colorGroup(v,min,max){if(!isNum(v))return"";const x=toNum(v);let t=(x-min)/(max-min);const hue=0+t*120;return`background:hsl(${hue} 80% 92%)`;}
function colorNeste6(v,min,max){if(!isNum(v))return"";const x=toNum(v);let t=(x-min)/(max-min);
  const hue=210, sat=90, light=92 - t*32; // sterkere kontrast
  return`background:hsl(${hue} ${sat}% ${light}%)`;
}
function computeRange(rows,cols){let min=Infinity,max=-Infinity,any=false;for(const r of rows){for(const c of cols){const v=r[c];if(isNum(v)){const num=toNum(v);if(isFinite(num)){any=true;if(num<min)min=num;if(num>max)max=num;}}}}return any&&max>min?{min,max}:null;}
function computeSingle(rows,col){let min=Infinity,max=-Infinity,any=false;for(const r of rows){const v=r[col];if(isNum(v)){const num=toNum(v);if(isFinite(num)){any=true;if(num<min)min=num;if(num>max)max=num;}}}return any&&max>min?{min,max}:null;}

function renderHeader(){const tr=document.createElement("tr");VISIBLE_COLUMNS.forEach(col=>{const th=document.createElement("th");const btn=document.createElement("button");btn.textContent=col;btn.onclick=()=>{if(sortCol===col)sortDir*=-1;else{sortCol=col;sortDir=1;}render();};th.append(btn);if(sortCol===col){const s=document.createElement("span");s.className="sort-ind";s.textContent=sortDir===1?"▲":"▼";th.append(s);}tr.append(th);});thead.innerHTML="";thead.append(tr);}
function render(){renderHeader();let rows=DATA.filter(rowMatches);if(sortCol)rows.sort((a,b)=>sortDir*cmp(a[sortCol],b[sortCol]));
 const groupR=computeRange(rows,GROUP_COLUMNS);const nesteR=VISIBLE_COLUMNS.includes(NESTE6_COLUMN)?computeSingle(rows,NESTE6_COLUMN):null;
 tbody.innerHTML="";const frag=document.createDocumentFragment();
 for(const row of rows){const tr=document.createElement("tr");tr.innerHTML=VISIBLE_COLUMNS.map(c=>{
   let style="";if(GROUP_COLUMNS.includes(c)&&groupR)style=colorGroup(row[c],groupR.min,groupR.max);
   else if(c===NESTE6_COLUMN&&nesteR)style=colorNeste6(row[c],nesteR.min,nesteR.max);
   let val=row[c]??"";if(detectedNameCol&&c===detectedNameCol)val=`<strong>${val}</strong>`;return`<td style="${style}">${val}</td>`;
 }).join("");frag.append(tr);}tbody.append(frag);
 shown.textContent=rows.length;total.textContent=DATA.length;}

function rowMatches(r){const qv=(q.value||"").toLowerCase();if(qv){const hit=VISIBLE_COLUMNS.some(c=>String(r[c]??"").toLowerCase().includes(qv));if(!hit)return false;}if(detectedPositionCol&&activePositions.size>0){const pv=String(r[detectedPositionCol]??"").trim();if(!activePositions.has(pv))return false;}return true;}
function detectPos(cols){const cands=["posisjon","position","pos","rolle","role"];const lower=cols.map(c=>c.toLowerCase());for(let i=0;i<lower.length;i++)if(cands.includes(lower[i]))return cols[i];return"";}

Papa.parse(CSV_URL,{download:true,header:true,dynamicTyping:true,complete:(res)=>{
 RAW_COLUMNS=res.meta.fields;const hideIdx=new Set(HIDE_BY_LETTER.map(letterToIndex));VISIBLE_COLUMNS=RAW_COLUMNS.filter((c,i)=>!hideIdx.has(i));
 detectedNameCol=detectInsensitive(RAW_COLUMNS,NAME_PREF);detectedPositionCol=detectPos(RAW_COLUMNS);
 DATA=res.data;render();
}});
q.oninput=render;reset.onclick=()=>{q.value="";sortCol=null;sortDir=1;render();};
</script>
</body>
</html>
