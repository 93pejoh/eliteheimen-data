<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Byttekalkulator</title>
  <style>
    :root{ --bg:#0a1f44; --panel:#12356c; --panel2:#0d2a5f; --text:#f0f6ff; --red:#c23b50; --green:#2aa764; --line:rgba(255,255,255,.09); }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1220px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 14px;font-weight:800;letter-spacing:.2px}
    .card{background:var(--panel);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.35);overflow:hidden}

    .grid{display:grid;grid-template-columns:140px 1fr 1fr repeat(6,110px)}
    .cell{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center}
    .head{background:#0c2b63;font-weight:800;letter-spacing:.3px}
    .head .cell:nth-child(2){background:var(--red)}
    .head .cell:nth-child(3){background:var(--green)}
    .pos{font-weight:700}
    .num{justify-content:flex-end;font-variant-numeric:tabular-nums}
    .divider{grid-column:1/-1;height:2px;background:rgba(255,255,255,.12)}
    .sumrow{background:#153b7d}
    .sumrow .cell:first-child{font-weight:800}
    .sumrow.red  .cell:first-child{background:var(--red)}
    .sumrow.green .cell:first-child{background:var(--green)}
    .diffrow{background:#0e2756}
    .diffrow .big{grid-column:2/4;background:#e9f5ee;color:#052d13;border-radius:12px;margin:6px;padding:14px 16px;display:flex;justify-content:center;font-size:28px;font-weight:900}

    select{
      width:100%;appearance:none;-webkit-appearance:none;-moz-appearance:none;
      background:var(--panel2) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>') no-repeat right 10px center;
      border:1px solid rgba(255,255,255,.18);padding:10px 36px 10px 12px;border-radius:12px;color:#fff;font-weight:600;letter-spacing:.1px
    }

    .status{max-width:1220px;margin:10px auto 30px;padding:8px 12px;color:#cfe1ff;opacity:.9}
    .muted{opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Byttekalkulator</h1>

    <div class="card">
      <!-- HEADER -->
      <div class="grid head">
        <div class="cell">POSISJON</div>
        <div class="cell">FØR BYTTER</div>
        <div class="cell">ETTER BYTTER</div>
        <div class="cell">R25</div><div class="cell">R26</div><div class="cell">R27</div>
        <div class="cell">R28</div><div class="cell">R29</div><div class="cell">R30</div>
      </div>

      <!-- RADER (hardkodet – kan ikke “forsvinne”) -->
      <div id="rows">
        <!-- 2 Keepere -->
        <div class="grid r" data-pos="Keeper">
          <div class="cell pos">Keeper</div>
          <div class="cell"><select class="pick before" data-pos="Keeper"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Keeper"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Keeper">
          <div class="cell pos">Keeper</div>
          <div class="cell"><select class="pick before" data-pos="Keeper"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Keeper"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="divider"></div>

        <!-- 5 Forsvar -->
        <div class="grid r" data-pos="Forsvar">
          <div class="cell pos">Forsvar</div>
          <div class="cell"><select class="pick before" data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Forsvar">
          <div class="cell pos">Forsvar</div>
          <div class="cell"><select class="pick before" data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Forsvar">
          <div class="cell pos">Forsvar</div>
          <div class="cell"><select class="pick before" data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Forsvar">
          <div class="cell pos">Forsvar</div>
          <div class="cell"><select class="pick before" data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Forsvar">
          <div class="cell pos">Forsvar</div>
          <div class="cell"><select class="pick before" data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Forsvar"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="divider"></div>

        <!-- 5 Midtbane -->
        <div class="grid r" data-pos="Midtbane">
          <div class="cell pos">Midtbane</div>
          <div class="cell"><select class="pick before" data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Midtbane">
          <div class="cell pos">Midtbane</div>
          <div class="cell"><select class="pick before" data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Midtbane">
          <div class="cell pos">Midtbane</div>
          <div class="cell"><select class="pick before" data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Midtbane">
          <div class="cell pos">Midtbane</div>
          <div class="cell"><select class="pick before" data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Midtbane">
          <div class="cell pos">Midtbane</div>
          <div class="cell"><select class="pick before" data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Midtbane"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="divider"></div>

        <!-- 3 Angrep -->
        <div class="grid r" data-pos="Angrep">
          <div class="cell pos">Angrep</div>
          <div class="cell"><select class="pick before" data-pos="Angrep"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Angrep"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Angrep">
          <div class="cell pos">Angrep</div>
          <div class="cell"><select class="pick before" data-pos="Angrep"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Angrep"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
        <div class="grid r" data-pos="Angrep">
          <div class="cell pos">Angrep</div>
          <div class="cell"><select class="pick before" data-pos="Angrep"><option value="">VELG HER</option></select></div>
          <div class="cell"><select class="pick after"  data-pos="Angrep"><option value="">VELG HER</option></select></div>
          <div class="cell num"><span data-round="R25">0,00</span></div><div class="cell num"><span data-round="R26">0,00</span></div><div class="cell num"><span data-round="R27">0,00</span></div><div class="cell num"><span data-round="R28">0,00</span></div><div class="cell num"><span data-round="R29">0,00</span></div><div class="cell num"><span data-round="R30">0,00</span></div>
        </div>
      </div>

      <!-- SUMMER -->
      <div class="grid sumrow red">
        <div class="cell">FØR BYTTER</div>
        <div class="cell num"><strong id="sumBeforeTotal">0,00</strong></div>
        <div class="cell"></div>
        <div class="cell num" id="bR25">0,00</div><div class="cell num" id="bR26">0,00</div><div class="cell num" id="bR27">0,00</div>
        <div class="cell num" id="bR28">0,00</div><div class="cell num" id="bR29">0,00</div><div class="cell num" id="bR30">0,00</div>
      </div>
      <div class="grid sumrow green">
        <div class="cell">ETTER BYTTER</div>
        <div class="cell num"><strong id="sumAfterTotal">0,00</strong></div>
        <div class="cell"></div>
        <div class="cell num" id="aR25">0,00</div><div class="cell num" id="aR26">0,00</div><div class="cell num" id="aR27">0,00</div>
        <div class="cell num" id="aR28">0,00</div><div class="cell num" id="aR29">0,00</div><div class="cell num" id="aR30">0,00</div>
      </div>

      <div class="grid diffrow">
        <div class="cell">DIFFERANSE</div>
        <div class="big" id="diffTotal">0,00</div>
        <div class="cell"></div>
        <div class="cell num" id="dR25"><strong>0,00</strong></div><div class="cell num" id="dR26"><strong>0,00</strong></div><div class="cell num" id="dR27"><strong>0,00</strong></div>
        <div class="cell num" id="dR28"><strong>0,00</strong></div><div class="cell num" id="dR29"><strong>0,00</strong></div><div class="cell num" id="dR30"><strong>0,00</strong></div>
      </div>
    </div>

    <div class="status muted" id="status">
      Nedtrekk fylles fra <code>../data.csv</code>. Kolonner: <em>Navn/Name</em>, <em>Pos/Posisjon/Position</em>, <em>R25–R30</em>.
    </div>
  </div>

  <script>
    // Konstanter + helpers
    const ROUNDS = ['R25','R26','R27','R28','R29','R30'];
    const currency = n => (Math.round((n||0)*100)/100).toFixed(2).replace('.', ',');
    const toNum = v => { const s=String(v??'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
    const setStatus = m => { const el=document.getElementById('status'); if(el) el.innerHTML=m; };

    const state = { players: [], byPos:{Keeper:[],Forsvar:[],Midtbane:[],Angrep:[]}, rows: [] };

    // Samle referanser til alle ferdiglagde rader
    document.querySelectorAll('#rows .r').forEach(rowEl=>{
      const pos = rowEl.getAttribute('data-pos');
      const beforeSel = rowEl.querySelector('select.before');
      const afterSel  = rowEl.querySelector('select.after');
      const cells = {};
      rowEl.querySelectorAll('[data-round]').forEach(sp => { cells[sp.dataset.round] = sp; });
      state.rows.push({ pos, beforeSel, afterSel, cells });
    });
    state.rows.forEach(r=>{
      r.beforeSel.addEventListener('change', render);
      r.afterSel.addEventListener('change', render);
    });

    // CSV utils (robust header-matching)
    function parseCSV(text){
      const rawLines = text.split(/\r?\n/);
      const lines = rawLines.filter(l => l.trim().length > 0);
      const headerRaw = (lines.shift() || '');
      const sep = [',',';','\t','|'].sort((a,b)=> (headerRaw.split(b).length) - (headerRaw.split(a).length))[0] || ',';
      const headers = headerRaw.replace(/\uFEFF/g,'').split(sep).map(h => h.trim());
      const rows = lines.map(line => {
        const cells = line.split(sep);
        const o = {}; headers.forEach((h,i)=> o[h] = (cells[i] !== undefined ? cells[i] : '').trim());
        return o;
      });
      const norm = s => String(s||'').toLowerCase().replace(/[\s_-]+/g,'');
      return { headers, rows, norm };
    }
    function pickHeader(headers, norm, names){
      const targets = names.map(n => norm(n));
      return headers.find(h => targets.includes(norm(h))) || null;
    }
    const normalizePos = v=>{
      const s=String(v||'').toLowerCase();
      if(/keep/.test(s)) return 'Keeper';
      if(/fors|def/.test(s)) return 'Forsvar';
      if(/midt|mid/.test(s)) return 'Midtbane';
      if(/ang|spiss|forw|strik/.test(s)) return 'Angrep';
      return (String(v||'').trim()||'');
    };

    async function loadCSV(){
      try{
        setStatus('Laster <code>../data.csv</code> …');
        const res = await fetch('../data.csv', { cache:'no-store' });
        if(!res.ok) throw new Error('Fant ikke ../data.csv ('+res.status+')');
        const text = await res.text();
        const { headers, rows, norm } = parseCSV(text);

        const colName = pickHeader(headers, norm, ['Navn','Name']);
        const colPos  = pickHeader(headers, norm, ['Pos','Posisjon','Position']);
        if(!colName || !colPos){ setStatus('Fant ikke kolonnene Navn/Pos i <code>data.csv</code>.'); return; }

        // Kartlegg faktisk header for hver runde (tåler «R 25», «r25», «R_25», etc.)
        const roundHeaderMap = {};
        ROUNDS.forEach(r=>{
          const h = pickHeader(headers, norm, [r]);
          if(h) roundHeaderMap[r] = h;
        });

        // Spillere: lagre både tall og råtekst per runde
        state.players = rows.map(r=>{
          const p = { Navn:r[colName], Pos:normalizePos(r[colPos]), raw:{} };
          ROUNDS.forEach(k=>{
            const hdr  = roundHeaderMap[k];
            const cell = hdr ? r[hdr] : '';
            p[k]     = toNum(cell);
            p.raw[k] = (cell ?? '').toString().trim();
          });
          return p;
        }).filter(p => p.Navn);

        // Grupper navn pr. posisjon
        state.byPos = {Keeper:[],Forsvar:[],Midtbane:[],Angrep:[]};
        state.players.forEach(p=>{ if(state.byPos[p.Pos]) state.byPos[p.Pos].push(p.Navn); });
        Object.values(state.byPos).forEach(list => list.sort((a,b)=>a.localeCompare(b,'no')));

        // Fyll alle selects
        document.querySelectorAll('select.pick').forEach(sel=>{
          const need = sel.getAttribute('data-pos');
          const list = state.byPos[need] || [];
          sel.innerHTML = '<option value="">VELG HER</option>' + list.map(n=>`<option>${n}</option>`).join('');
        });

        setStatus('Klar ✅ – navn og runde-kolonner lastet.');
        render();
      }catch(e){
        console.error(e);
        setStatus('Klar ⚠️ – fikk ikke lastet <code>../data.csv</code>. Nedtrekk står med «VELG HER».');
      }
    }

    function getPlayer(name){ return state.players.find(p=>p.Navn===name); }

    function render(){
      const totalsB = Object.fromEntries(ROUNDS.map(r=>[r,0]));
      const totalsA = Object.fromEntries(ROUNDS.map(r=>[r,0]));

      state.rows.forEach(row=>{
        const b = getPlayer(row.beforeSel.value);
        const a = getPlayer(row.afterSel.value);
        ROUNDS.forEach(r=>{
          // Vis nøyaktig CSV-verdi for ETTER-valget i raden
          const raw = a ? (a.raw?.[r] ?? '') : '';
          row.cells[r].textContent = raw || '0,00';
          // Summer med tallverdier
          totalsB[r] += b ? (b[r]||0) : 0;
          totalsA[r] += a ? (a[r]||0) : 0;
        });
      });

      ROUNDS.forEach(r=>{
        document.getElementById('b'+r).textContent = currency(totalsB[r]);
        document.getElementById('a'+r).textContent = currency(totalsA[r]);
        document.getElementById('d'+r).textContent = currency(totalsA[r] - totalsB[r]);
      });

      const sumB = Object.values(totalsB).reduce((x,y)=>x+y,0);
      const sumA = Object.values(totalsA).reduce((x,y)=>x+y,0);
      document.getElementById('sumBeforeTotal').textContent = currency(sumB);
      document.getElementById('sumAfterTotal').textContent  = currency(sumA);
      document.getElementById('diffTotal').textContent      = currency(sumA - sumB);
    }

    loadCSV();
  </script>
</body>
</html>
