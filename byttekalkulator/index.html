<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Byttekalkulator – rundeverdier koblet til navn</title>
  <style>
    :root{
      --bg:#0a1f44; --panel:#12356c; --panel2:#0d2a5f; --text:#f0f6ff;
      --red:#c23b50; --green:#2aa764; --line:rgba(255,255,255,.09);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1220px;margin:28px auto;padding:0 16px}
    h1{margin:0 0 14px;font-weight:800;letter-spacing:.2px}
    .card{background:var(--panel);border-radius:18px;box-shadow:0 10px 24px rgba(0,0,0,.35);overflow:hidden}

    /* GRID */
    .grid{display:grid;grid-template-columns:140px 1fr 1fr repeat(6,110px)}
    .cell{padding:12px;border-bottom:1px solid var(--line);display:flex;align-items:center}
    .head{background:#0c2b63;font-weight:800;letter-spacing:.3px}
    .head .cell:nth-child(2){background:var(--red)}
    .head .cell:nth-child(3){background:var(--green)}
    .pos{font-weight:700}
    .num{justify-content:flex-end;font-variant-numeric:tabular-nums}
    .divider{grid-column:1/-1;height:2px;background:rgba(255,255,255,.12)}
    .sumrow{background:#153b7d}
    .sumrow .cell:first-child{font-weight:800}
    .sumrow.red  .cell:first-child{background:var(--red)}
    .sumrow.green .cell:first-child{background:var(--green)}
    .diffrow{background:#0e2756}
    .diffrow .big{grid-column:2/4;background:#e9f5ee;color:#052d13;border-radius:12px;margin:6px;padding:14px 16px;display:flex;justify-content:center;font-size:28px;font-weight:900}

    /* SELECT */
    select{
      width:100%;appearance:none;-webkit-appearance:none;-moz-appearance:none;
      background:var(--panel2) url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>') no-repeat right 10px center;
      border:1px solid rgba(255,255,255,.18);padding:10px 36px 10px 12px;border-radius:12px;color:#fff;
      font-weight:600;letter-spacing:.1px
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Byttekalkulator – statisk ramme</h1>

    <div class="card" id="app">
      <!-- HEADER -->
      <div class="grid head">
        <div class="cell">POSISJON</div>
        <div class="cell">FØR BYTTER</div>
        <div class="cell">ETTER BYTTER</div>
        <div class="cell">R25</div>
        <div class="cell">R26</div>
        <div class="cell">R27</div>
        <div class="cell">R28</div>
        <div class="cell">R29</div>
        <div class="cell">R30</div>
      </div>

      <!-- RADER (genereres i JS) -->
      <div id="rows"></div>

      <!-- SUMMER -->
      <div class="grid sumrow red">
        <div class="cell">FØR BYTTER</div>
        <div class="cell num"><strong id="sumBeforeTotal">0,00</strong></div>
        <div class="cell"></div>
        <div class="cell num" id="bR25">0,00</div>
        <div class="cell num" id="bR26">0,00</div>
        <div class="cell num" id="bR27">0,00</div>
        <div class="cell num" id="bR28">0,00</div>
        <div class="cell num" id="bR29">0,00</div>
        <div class="cell num" id="bR30">0,00</div>
      </div>
      <div class="grid sumrow green">
        <div class="cell">ETTER BYTTER</div>
        <div class="cell num"><strong id="sumAfterTotal">0,00</strong></div>
        <div class="cell"></div>
        <div class="cell num" id="aR25">0,00</div>
        <div class="cell num" id="aR26">0,00</div>
        <div class="cell num" id="aR27">0,00</div>
        <div class="cell num" id="aR28">0,00</div>
        <div class="cell num" id="aR29">0,00</div>
        <div class="cell num" id="aR30">0,00</div>
      </div>

      <div class="grid diffrow">
        <div class="cell">DIFFERANSE</div>
        <div class="big" id="diffTotal">0,00</div>
        <div class="cell"></div>
        <div class="cell num" id="dR25"><strong>0,00</strong></div>
        <div class="cell num" id="dR26"><strong>0,00</strong></div>
        <div class="cell num" id="dR27"><strong>0,00</strong></div>
        <div class="cell num" id="dR28"><strong>0,00</strong></div>
        <div class="cell num" id="dR29"><strong>0,00</strong></div>
        <div class="cell num" id="dR30"><strong>0,00</strong></div>
      </div>
    </div>

    <p style="opacity:.8;margin:12px 0 24px">Runde-verdier hentes fra <code>../data.csv</code> og kobles til valgte spillere. Kolonner: <em>Navn/Name</em>, <em>Pos/Posisjon/Position</em>, <em>R25–R30</em>.</p>
  </div>

  <script>
    // --------- Oppsett ---------
    const ROUNDS = ['R25','R26','R27','R28','R29','R30'];
    const LAYOUT = [
      { pos:'Keeper',   count: 2 },
      { pos:'Forsvar',  count: 5 },
      { pos:'Midtbane', count: 5 },
      { pos:'Angrep',   count: 3 },
    ];

    const state = {
      players: [],           // {Navn, Pos, R25..R30}
      byPos: {Keeper:[],Forsvar:[],Midtbane:[],Angrep:[]},
      rows: []               // [{pos, beforeSel, afterSel, cells:{R25:el,..}}]
    };

    const currency = n => (Math.round((n||0)*100)/100).toFixed(2).replace('.', ',');
    const toNum = v => { const s=String(v??'').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };

    // --------- Bygg rader ---------
    function makeRows(){
      const host = document.getElementById('rows');
      host.innerHTML = '';
      state.rows = [];
      LAYOUT.forEach(group => {
        const grid = document.createElement('div'); grid.className='grid';
        for(let i=0;i<group.count;i++){
          const row = document.createElement('div'); row.className='row';
          grid.insertAdjacentHTML('beforeend', `
            <div class="cell pos">${group.pos}</div>
            <div class="cell"><select class="pick before"><option value="">VELG HER</option></select></div>
            <div class="cell"><select class="pick after"><option value="">VELG HER</option></select></div>
            ${ROUNDS.map(r=>`<div class="cell num"><span data-round="${r}">0,00</span></div>`).join('')}
          `);
        }
        host.appendChild(grid);
        const div = document.createElement('div'); div.className='divider'; host.appendChild(div);
      });

      // registrer referanser pr. rad
      // Finn alle "grid"-seksjoner vi nettopp lagde
      const grids = Array.from(document.querySelectorAll('#rows > .grid'));
      let gridIdx=0;
      LAYOUT.forEach(group=>{
        const g = grids[gridIdx++];
        // i hvert grid er det group.count rader, hver rad har (1 pos + 2 selects + 6 rounds) = 9 celler
        const cells = Array.from(g.children);
        for(let r=0;r<group.count;r++){
          const base = r*9;
          const posCell = cells[base+0];
          const beforeSel = cells[base+1].querySelector('select');
          const afterSel  = cells[base+2].querySelector('select');
          const cellMap = {};
          ROUNDS.forEach((round,idx)=>{ cellMap[round] = cells[base+3+idx].querySelector('[data-round]'); });
          state.rows.push({pos:group.pos, beforeSel, afterSel, cells:cellMap});
        }
      });

      // change-handlere
      state.rows.forEach(row=>{
        row.beforeSel.addEventListener('change', render);
        row.afterSel.addEventListener('change', render);
      });
    }

    // --------- CSV ---------
    function parseCSV(text) {
      const first = (text.split(/
?
/).find(Boolean) || '');
      const sep = [',',';','	'].sort((a,b) => (first.split(b).length) - (first.split(a).length))[0] || ',';
      const lines = text.trim().split(/
?
/).filter(Boolean);
      const headers = (lines.shift() || '').split(sep).map(h => h.trim());
      const rows = lines.map(line => {
        const cells = line.split(sep).map(x => x.trim());
        const o = {}; headers.forEach((h, i) => o[h] = (cells[i] ?? ''));
        return o;
      });
      return { headers, rows };
    }

    const pickHeader = (headers, names) => headers.find(h => new RegExp('^(' + names.join('|') + ')$', 'i').test(h));
    const normalizePos = v => {
      const s = String(v || '').toLowerCase();
      if (/keep/.test(s)) return 'Keeper';
      if (/fors|def/.test(s)) return 'Forsvar';
      if (/midt|mid/.test(s)) return 'Midtbane';
      if (/ang|spiss|forw|strik/.test(s)) return 'Angrep';
      return v || '';
    };

    async function loadCSV(){
      try {
        const res = await fetch('../data.csv', { cache: 'no-store' });
        if(!res.ok) throw new Error('Fant ikke ../data.csv');
        const text = await res.text();
        const { headers, rows } = parseCSV(text);
        const colName = pickHeader(headers, ['Navn','Name']);
        const colPos  = pickHeader(headers, ['Pos','Posisjon','Position']);
        if(!colName || !colPos) return;

        // hvilke runde-kolonner finnes faktisk i fila
        const roundCols = ROUNDS.filter(r => headers.includes(r) || headers.map(h=>h.toUpperCase()).includes(r));

        state.players = rows.map(r => {
          const o = { Navn: r[colName], Pos: normalizePos(r[colPos]) };
          roundCols.forEach(k => o[k] = toNum(r[k]));
          return o;
        }).filter(p=>p.Navn);

        // grupper etter posisjon og sorter navn (behold original casing)
        state.byPos = {Keeper:[],Forsvar:[],Midtbane:[],Angrep:[]};
        state.players.forEach(p=>{ if(state.byPos[p.Pos]) state.byPos[p.Pos].push(p.Navn); });
        Object.values(state.byPos).forEach(list=> list.sort((a,b)=> a.localeCompare(b,'no')));

        // fyll alle selects
        state.rows.forEach(row=>{
          const names = state.byPos[row.pos] || [];
          const options = ['<option value="">VELG HER</option>', ...names.map(n=>`<option>${n}</option>`)].join('');
          row.beforeSel.innerHTML = options;
          row.afterSel.innerHTML  = options;
        });

        // første render
        render();
      } catch(e){ console.warn(e); }
    }

    // --------- Render/summer ---------
    function getPlayerByName(name){ return state.players.find(p=>p.Navn===name); }

    function render(){
      const totalsBefore = Object.fromEntries(ROUNDS.map(r=>[r,0]));
      const totalsAfter  = Object.fromEntries(ROUNDS.map(r=>[r,0]));

      state.rows.forEach(row=>{
        const before = getPlayerByName(row.beforeSel.value);
        const after  = getPlayerByName(row.afterSel.value);
        ROUNDS.forEach(r=>{
          const valAfter = after ? (after[r]||0) : 0;
          row.cells[r].textContent = currency(valAfter); // vis etter-bytter i radene
          totalsBefore[r] += before ? (before[r]||0) : 0;
          totalsAfter[r]  += after  ? (after[r] ||0) : 0;
        });
      });

      // skriv summer per runde
      ROUNDS.forEach(r=>{
        document.getElementById('b'+r).textContent = currency(totalsBefore[r]);
        document.getElementById('a'+r).textContent = currency(totalsAfter[r]);
        document.getElementById('d'+r).textContent = currency(totalsAfter[r] - totalsBefore[r]);
      });

      // totalsummer (sum over alle runder)
      const sumB = Object.values(totalsBefore).reduce((a,b)=>a+b,0);
      const sumA = Object.values(totalsAfter ).reduce((a,b)=>a+b,0);
      document.getElementById('sumBeforeTotal').textContent = currency(sumB);
      document.getElementById('sumAfterTotal').textContent  = currency(sumA);
      document.getElementById('diffTotal').textContent      = currency(sumA - sumB);
    }

    // Init
    makeRows();
    loadCSV();
  </script>
</body>
</html>
